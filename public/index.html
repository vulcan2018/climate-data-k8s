<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Data Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        /* Sidebar */
        #sidebar {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 340px;
            background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid #1e293b;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        #sidebar.collapsed {
            transform: translateX(-340px);
        }
        #sidebar-toggle {
            position: absolute;
            top: 10px;
            left: 350px;
            z-index: 1001;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            color: #94a3b8;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease;
        }
        #sidebar.collapsed ~ #sidebar-toggle { left: 10px; }
        #sidebar-toggle:hover { color: #f1f5f9; border-color: #64748b; }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-header h1 {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
        }
        .sidebar-header h1 span { color: #38bdf8; }
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: #64748b;
        }
        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .section {
            padding: 14px 20px;
            border-bottom: 1px solid #1e293b;
        }
        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            margin-bottom: 10px;
        }

        /* Layer toggles */
        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
        }
        .layer-item label {
            font-size: 0.85rem;
            color: #cbd5e1;
            cursor: pointer;
            flex: 1;
        }
        .layer-item input[type="checkbox"] {
            accent-color: #38bdf8;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .layer-desc {
            font-size: 0.72rem;
            color: #475569;
            padding-left: 26px;
            margin-top: -2px;
            margin-bottom: 4px;
        }

        /* Dataset selector */
        .dataset-select {
            width: 100%;
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .dataset-select:focus { outline: 1px solid #38bdf8; }

        .era5-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .era5-toggle label {
            font-size: 0.85rem;
            color: #cbd5e1;
            cursor: pointer;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }
        .opacity-control label {
            font-size: 0.75rem;
            color: #64748b;
            min-width: 50px;
        }
        .opacity-control input[type="range"] {
            flex: 1;
            accent-color: #38bdf8;
        }

        /* Click info panel */
        #click-info {
            padding: 14px 20px;
            border-bottom: 1px solid #1e293b;
            display: none;
        }
        #click-info.active { display: block; }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.82rem;
        }
        .info-row .info-label { color: #64748b; }
        .info-row .info-value { color: #e2e8f0; font-variant-numeric: tabular-nums; }
        .info-temp {
            font-size: 1.6rem;
            font-weight: 700;
            color: #38bdf8;
            margin: 6px 0;
        }
        .info-temp-c {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        /* Color scale legend */
        .legend {
            margin-top: 10px;
        }
        .legend-bar {
            height: 12px;
            border-radius: 2px;
            margin-bottom: 4px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #64748b;
        }

        /* Sources */
        .sources {
            margin-top: auto;
            padding: 14px 20px;
            border-top: 1px solid #1e293b;
        }
        .sources a {
            display: block;
            font-size: 0.72rem;
            color: #475569;
            text-decoration: none;
            padding: 2px 0;
        }
        .sources a:hover { color: #94a3b8; }
        .sources .source-label {
            font-size: 0.65rem;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .footer-brand {
            padding: 10px 20px;
            border-top: 1px solid #1e293b;
            font-size: 0.7rem;
            color: #334155;
            text-align: center;
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0f172a;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            transition: opacity 0.5s;
        }
        #loading-overlay.fade-out { opacity: 0; pointer-events: none; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid #1e293b;
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #64748b; font-size: 0.85rem; }

        /* Leaflet overrides */
        .leaflet-control-zoom { border: 1px solid #334155 !important; }
        .leaflet-control-zoom a {
            background: rgba(15, 23, 42, 0.9) !important;
            color: #94a3b8 !important;
            border-color: #334155 !important;
        }
        .leaflet-control-zoom a:hover {
            background: rgba(30, 41, 59, 0.95) !important;
            color: #f1f5f9 !important;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading climate data...</div>
    </div>

    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h1><span>&#9670;</span> Climate Data Platform</h1>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Live</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Satellite Layers (EUMETSAT WMS)</div>
            <div id="wms-layers"></div>
        </div>

        <div class="section">
            <div class="section-title">ERA5 Reanalysis Data</div>
            <div class="era5-toggle">
                <input type="checkbox" id="era5-toggle" checked>
                <label for="era5-toggle">Show temperature grid</label>
            </div>
            <select class="dataset-select" id="era5-dataset">
                <option value="era5_t2m_20240101">January 2024 (Winter NH)</option>
                <option value="era5_t2m_20240701">July 2024 (Summer NH)</option>
            </select>
            <div class="opacity-control">
                <label>Opacity</label>
                <input type="range" id="era5-opacity" min="0" max="100" value="70">
            </div>
            <div class="legend">
                <div class="legend-bar" id="legend-bar"></div>
                <div class="legend-labels">
                    <span>-60&deg;C (213K)</span>
                    <span>0&deg;C</span>
                    <span>+45&deg;C (318K)</span>
                </div>
            </div>
        </div>

        <div id="click-info">
            <div class="section-title">Point Query</div>
            <div class="info-temp" id="info-temp">--</div>
            <div class="info-temp-c" id="info-temp-c"></div>
            <div class="info-row">
                <span class="info-label">Latitude</span>
                <span class="info-value" id="info-lat">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Longitude</span>
                <span class="info-value" id="info-lon">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Dataset</span>
                <span class="info-value" id="info-dataset">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Grid Cell</span>
                <span class="info-value" id="info-grid">--</span>
            </div>
        </div>

        <div class="sources">
            <div class="source-label">Data Sources</div>
            <a href="https://cds.climate.copernicus.eu/" target="_blank">Copernicus Climate Data Store (ERA5)</a>
            <a href="https://view.eumetsat.int/" target="_blank">EUMETSAT Data Viewer (Satellite WMS)</a>
            <a href="https://www.ecmwf.int/en/forecasts/dataset/ecmwf-reanalysis-v5" target="_blank">ECMWF ERA5 Documentation</a>
        </div>

        <div class="footer-brand">Climate Data Platform &mdash; FIRA Software Ltd</div>
    </div>

    <button id="sidebar-toggle" title="Toggle sidebar">&#9776;</button>

    <script>
    (function() {
        'use strict';

        // ── State ──
        let map, era5Canvas, era5Data = null, clickMarker = null;
        const wmsOverlays = {};

        // ── Color scale for temperature (213K to 318K → -60°C to +45°C) ──
        const T_MIN = 213, T_MAX = 318;
        const COLOR_STOPS = [
            [0.00, [10, 0, 60]],     // deep purple  (-60°C)
            [0.15, [30, 50, 180]],   // blue         (-44°C)
            [0.30, [30, 130, 200]],  // cyan-blue    (-28°C)
            [0.42, [40, 180, 160]],  // teal         (-16°C)
            [0.52, [80, 200, 80]],   // green        (-5°C)
            [0.62, [180, 220, 50]],  // yellow-green (+5°C)
            [0.72, [240, 200, 30]],  // yellow       (+16°C)
            [0.82, [240, 140, 20]],  // orange       (+27°C)
            [0.92, [220, 60, 30]],   // red          (+38°C)
            [1.00, [150, 20, 20]],   // dark red     (+45°C)
        ];

        function tempToColor(kelvin) {
            const t = Math.max(0, Math.min(1, (kelvin - T_MIN) / (T_MAX - T_MIN)));
            for (let i = 1; i < COLOR_STOPS.length; i++) {
                if (t <= COLOR_STOPS[i][0]) {
                    const [t0, c0] = COLOR_STOPS[i - 1];
                    const [t1, c1] = COLOR_STOPS[i];
                    const f = (t - t0) / (t1 - t0);
                    return [
                        Math.round(c0[0] + (c1[0] - c0[0]) * f),
                        Math.round(c0[1] + (c1[1] - c0[1]) * f),
                        Math.round(c0[2] + (c1[2] - c0[2]) * f),
                    ];
                }
            }
            return COLOR_STOPS[COLOR_STOPS.length - 1][1];
        }

        // Build legend gradient
        function buildLegend() {
            const steps = 100;
            const colors = [];
            for (let i = 0; i <= steps; i++) {
                const k = T_MIN + (T_MAX - T_MIN) * (i / steps);
                const c = tempToColor(k);
                colors.push(`rgb(${c[0]},${c[1]},${c[2]})`);
            }
            document.getElementById('legend-bar').style.background =
                `linear-gradient(to right, ${colors.join(',')})`;
        }

        // ── Map init ──
        function initMap() {
            map = L.map('map', {
                center: [20, 0],
                zoom: 3,
                minZoom: 2,
                maxZoom: 12,
                zoomControl: true,
                worldCopyJump: true,
            });

            // Custom panes for layer ordering:
            // base tiles (200) < ERA5 grid (250) < WMS satellite (350) < overlays (400)
            map.createPane('era5Pane');
            map.getPane('era5Pane').style.zIndex = 250;
            map.createPane('wmsPane');
            map.getPane('wmsPane').style.zIndex = 350;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19,
            }).addTo(map);

            // Move zoom control to bottom-right
            map.zoomControl.setPosition('bottomright');

            map.on('click', onMapClick);
        }

        // ── WMS layers ──
        const WMS_LAYERS = [
            {
                id: 'msg_fes:ir108',
                name: 'Meteosat IR 10.8\u00b5m',
                desc: 'Thermal infrared imagery',
                defaultOn: true,
            },
            {
                id: 'copernicus:daily_sentinel3ab_olci_l1_rgb_fulres',
                name: 'Sentinel-3 Natural Color',
                desc: 'OLCI daily composite',
                defaultOn: false,
            },
            {
                id: 'msg_fes:cth',
                name: 'Cloud Top Height',
                desc: 'MSG-derived cloud heights',
                defaultOn: false,
            },
            {
                id: 'msg_fes:fire',
                name: 'Active Fire Monitoring',
                desc: 'SEVIRI fire detection',
                defaultOn: false,
            },
        ];

        function initWMSLayers() {
            const container = document.getElementById('wms-layers');
            WMS_LAYERS.forEach(layer => {
                const wmsLayer = L.tileLayer.wms('https://view.eumetsat.int/geoserver/wms', {
                    layers: layer.id,
                    format: 'image/png',
                    transparent: true,
                    opacity: 0.7,
                    pane: 'wmsPane',
                    attribution: '&copy; EUMETSAT',
                });

                wmsOverlays[layer.id] = wmsLayer;

                if (layer.defaultOn) {
                    wmsLayer.addTo(map);
                }

                const itemDiv = document.createElement('div');
                itemDiv.innerHTML = `
                    <div class="layer-item">
                        <input type="checkbox" id="wms-${layer.id}" ${layer.defaultOn ? 'checked' : ''}>
                        <label for="wms-${layer.id}">${layer.name}</label>
                    </div>
                    <div class="layer-desc">${layer.desc}</div>
                `;
                container.appendChild(itemDiv);

                const cb = itemDiv.querySelector('input');
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        wmsLayer.addTo(map);
                    } else {
                        map.removeLayer(wmsLayer);
                    }
                });
            });
        }

        // ── ERA5 canvas overlay ──
        const ERA5CanvasLayer = L.Layer.extend({
            initialize: function(options) {
                L.setOptions(this, options);
                this._opacity = 0.7;
            },

            onAdd: function(map) {
                this._map = map;
                const pane = map.getPane('era5Pane');
                this._canvas = L.DomUtil.create('canvas', 'era5-canvas', pane);
                this._canvas.style.position = 'absolute';
                this._canvas.style.pointerEvents = 'none';
                this._canvas.style.opacity = this._opacity;
                map.on('moveend', this._redraw, this);
                map.on('zoomend', this._redraw, this);
                map.on('resize', this._redraw, this);
                this._redraw();
                return this;
            },

            onRemove: function(map) {
                L.DomUtil.remove(this._canvas);
                map.off('moveend', this._redraw, this);
                map.off('zoomend', this._redraw, this);
                map.off('resize', this._redraw, this);
            },

            setOpacity: function(val) {
                this._opacity = val;
                if (this._canvas) this._canvas.style.opacity = val;
            },

            setData: function(data) {
                this._data = data;
                if (this._map) this._redraw();
            },

            _redraw: function() {
                if (!this._data || !this._map) return;

                const size = this._map.getSize();
                const canvas = this._canvas;
                canvas.width = size.x;
                canvas.height = size.y;

                const topLeft = this._map.containerPointToLayerPoint([0, 0]);
                L.DomUtil.setPosition(canvas, topLeft);

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, size.x, size.y);

                const data = this._data;
                const bounds = this._map.getBounds();

                // Cell size in degrees
                const dLat = Math.abs(data.lats[0] - data.lats[1]);
                const dLon = Math.abs(data.lons[1] - data.lons[0]);

                // Determine world copies needed to fill the view
                const west = bounds.getWest();
                const east = bounds.getEast();
                const copyStart = Math.floor((west + 180) / 360);
                const copyEnd = Math.floor((east + 180) / 360);

                for (let i = 0; i < data.lats.length; i++) {
                    const lat = data.lats[i];
                    if (lat + dLat < bounds.getSouth() || lat - dLat > bounds.getNorth()) continue;

                    for (let copy = copyStart; copy <= copyEnd; copy++) {
                        const lonOffset = copy * 360;
                        for (let j = 0; j < data.lons.length; j++) {
                            const lon = data.lons[j] + lonOffset;

                            if (lon + dLon < west || lon - dLon > east) continue;

                            const val = data.values[i][j];
                            const color = tempToColor(val);

                            const nw = this._map.latLngToContainerPoint([lat + dLat/2, lon - dLon/2]);
                            const se = this._map.latLngToContainerPoint([lat - dLat/2, lon + dLon/2]);

                            const w = Math.max(1, se.x - nw.x);
                            const h = Math.max(1, se.y - nw.y);

                            ctx.fillStyle = `rgb(${color[0]},${color[1]},${color[2]})`;
                            ctx.fillRect(nw.x, nw.y, w, h);
                        }
                    }
                }
            }
        });

        // ── Load ERA5 data ──
        async function loadERA5(datasetId) {
            const url = `/data/${datasetId}.json`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                era5Data = await res.json();
                if (era5Canvas) {
                    era5Canvas.setData(era5Data);
                }
            } catch (err) {
                console.error('Failed to load ERA5 data:', err);
            }
        }

        // ── Map click handler ──
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            if (clickMarker) {
                map.removeLayer(clickMarker);
            }

            clickMarker = L.circleMarker(e.latlng, {
                radius: 6,
                color: '#38bdf8',
                fillColor: '#38bdf8',
                fillOpacity: 0.5,
                weight: 2,
            }).addTo(map);

            const panel = document.getElementById('click-info');
            panel.classList.add('active');

            document.getElementById('info-lat').textContent = lat.toFixed(4) + '\u00b0';
            document.getElementById('info-lon').textContent = lon.toFixed(4) + '\u00b0';

            const dsId = document.getElementById('era5-dataset').value;
            document.getElementById('info-dataset').textContent =
                dsId === 'era5_t2m_20240101' ? 'Jan 2024' : 'Jul 2024';

            if (era5Data) {
                // Find nearest grid cell
                const lats = era5Data.lats;
                const lons = era5Data.lons;

                let bestI = 0, bestDist = Infinity;
                for (let i = 0; i < lats.length; i++) {
                    const d = Math.abs(lats[i] - lat);
                    if (d < bestDist) { bestDist = d; bestI = i; }
                }

                let bestJ = 0;
                bestDist = Infinity;
                // Normalize lon to match data range
                let queryLon = lon;
                while (queryLon < lons[0]) queryLon += 360;
                while (queryLon > lons[lons.length-1] + 2.5) queryLon -= 360;

                for (let j = 0; j < lons.length; j++) {
                    const d = Math.abs(lons[j] - queryLon);
                    if (d < bestDist) { bestDist = d; bestJ = j; }
                }

                const tempK = era5Data.values[bestI][bestJ];
                const tempC = (tempK - 273.15).toFixed(1);

                document.getElementById('info-temp').textContent = tempK.toFixed(1) + ' K';
                document.getElementById('info-temp-c').textContent = tempC + ' \u00b0C';
                document.getElementById('info-grid').textContent =
                    `[${bestI},${bestJ}] (${lats[bestI].toFixed(1)}\u00b0, ${lons[bestJ].toFixed(1)}\u00b0)`;
            } else {
                document.getElementById('info-temp').textContent = 'No data';
                document.getElementById('info-temp-c').textContent = '';
                document.getElementById('info-grid').textContent = '--';
            }
        }

        // ── Sidebar toggle ──
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // ── Init ──
        async function init() {
            buildLegend();
            initMap();
            initWMSLayers();

            // Create ERA5 canvas layer
            era5Canvas = new ERA5CanvasLayer();
            era5Canvas.addTo(map);

            // Load initial dataset
            await loadERA5('era5_t2m_20240101');

            // Dataset selector
            document.getElementById('era5-dataset').addEventListener('change', function() {
                loadERA5(this.value);
            });

            // ERA5 toggle
            document.getElementById('era5-toggle').addEventListener('change', function() {
                if (this.checked) {
                    era5Canvas.addTo(map);
                } else {
                    map.removeLayer(era5Canvas);
                }
            });

            // Opacity slider
            document.getElementById('era5-opacity').addEventListener('input', function() {
                era5Canvas.setOpacity(this.value / 100);
            });

            // Check API status
            try {
                const res = await fetch('/api/v1/status');
                if (res.ok) {
                    document.getElementById('statusDot').style.background = '#22c55e';
                    document.getElementById('statusText').textContent = 'Live';
                }
            } catch {
                document.getElementById('statusDot').style.background = '#f59e0b';
                document.getElementById('statusText').textContent = 'API offline';
            }

            // Hide loading overlay
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('fade-out');
            setTimeout(() => overlay.remove(), 600);
        }

        init();
    })();
    </script>
</body>
</html>
